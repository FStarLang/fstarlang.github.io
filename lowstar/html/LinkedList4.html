<!DOCTYPE html>
<html class="writer-html5" lang="english" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Example: linked list &mdash; The KaRaMeL user manual  documentation</title>
      <link rel="stylesheet" type="text/css" href="static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="static/css/theme.css?v=86f27845" />

  
  
        <script src="static/jquery.js?v=8dae8fb0"></script>
        <script src="static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="static/documentation_options.js?v=df973ab0"></script>
        <script src="static/doctools.js?v=888ff710"></script>
        <script src="static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Example: RingBuffer" href="RingBuffer.html" />
    <link rel="prev" title="Low* examples" href="TocExamples.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            The KaRaMeL user manual
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="Introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="Setup.html">Tooling and project setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="Core.html">Low* language</a></li>
<li class="toctree-l1"><a class="reference internal" href="TocLibraries.html">Low* libraries</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="TocExamples.html">Low* examples</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">Example: linked list</a></li>
<li class="toctree-l2"><a class="reference internal" href="RingBuffer.html">Example: RingBuffer</a></li>
<li class="toctree-l2"><a class="reference internal" href="ExampleMemCpy.html">Example: <cite>memcpy</cite></a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="Toy.html">A toy project for learning Low*</a></li>
<li class="toctree-l1"><a class="reference internal" href="AdvancedTips.html">Advanced tips &amp; tricks</a></li>
<li class="toctree-l1"><a class="reference internal" href="AdvancedTopics.html">Advanced KaRaMeL topics</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">The KaRaMeL user manual</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="TocExamples.html">Low* examples</a></li>
      <li class="breadcrumb-item active">Example: linked list</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/LinkedList4.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="example-linked-list">
<h1>Example: linked list<a class="headerlink" href="#example-linked-list" title="Link to this heading">ÔÉÅ</a></h1>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="k">module</span> <span class="nc">LinkedList4</span>
<span class="k">open</span> <span class="nn">LowStar</span><span class="p">.</span><span class="nc">BufferOps</span>

<span class="k">module</span> <span class="nc">B</span> <span class="o">=</span> <span class="nn">LowStar</span><span class="p">.</span><span class="nc">Buffer</span>
<span class="k">module</span> <span class="nc">HS</span> <span class="o">=</span> <span class="nn">FStar</span><span class="p">.</span><span class="nc">HyperStack</span>
<span class="k">module</span> <span class="nc">G</span> <span class="o">=</span> <span class="nn">FStar</span><span class="p">.</span><span class="nc">Ghost</span>
<span class="k">module</span> <span class="nc">L</span> <span class="o">=</span> <span class="nn">FStar</span><span class="p">.</span><span class="nn">List</span><span class="p">.</span><span class="nc">Tot</span>
<span class="k">module</span> <span class="nc">U32</span> <span class="o">=</span> <span class="nn">FStar</span><span class="p">.</span><span class="nc">UInt32</span>
<span class="k">module</span> <span class="nc">MO</span> <span class="o">=</span> <span class="nn">LowStar</span><span class="p">.</span><span class="nc">Modifies</span>

<span class="k">open</span> <span class="nn">FStar</span><span class="p">.</span><span class="nn">HyperStack</span><span class="p">.</span><span class="nc">ST</span>

<span class="o">#</span><span class="n">set</span><span class="o">-</span><span class="n">options</span> <span class="s2">&quot;--__no_positivity&quot;</span>
</pre></div>
</div>
<p>We revisit the classic example of lists, but in a low-level
setting, using linked lists. This second version uses
<cite>B.pointer_or_null</cite>, the type of buffers of length 1 or 0.</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="k">noeq</span>
<span class="k">type</span> <span class="n">t</span> <span class="o">(</span><span class="n">a</span><span class="o">:</span> <span class="nc">Type0</span><span class="o">)</span> <span class="o">=</span>
  <span class="nn">B</span><span class="p">.</span><span class="n">pointer_or_null</span> <span class="o">(</span><span class="n">cell</span> <span class="n">a</span><span class="o">)</span>

<span class="n">and</span> <span class="n">cell</span> <span class="o">(</span><span class="n">a</span><span class="o">:</span> <span class="nc">Type0</span><span class="o">)</span> <span class="o">=</span> <span class="o">{</span>
  <span class="n">next</span><span class="o">:</span> <span class="n">t</span> <span class="n">a</span><span class="o">;</span>
  <span class="n">data</span><span class="o">:</span> <span class="n">a</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
</div>
<p>We enrich lists with a predicate that captures their length.  This
predicate will be needed for any traversal of the list, in order
to show termination.  This predicate also encodes the fact that
all cells of the list are live at the same time.  The absence of
cycles does not suffice to guarantee termination, as the number of
buffers in the heap is potentially infinite;</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="kd">let</span> <span class="kd">rec</span> <span class="n">well_formed</span> <span class="o">#</span><span class="n">a</span> <span class="o">(</span><span class="n">h</span><span class="o">:</span> <span class="nn">HS</span><span class="p">.</span><span class="n">mem</span><span class="o">)</span> <span class="o">(</span><span class="n">c</span><span class="o">:</span> <span class="n">t</span> <span class="n">a</span><span class="o">)</span> <span class="o">(</span><span class="n">l</span><span class="o">:</span> <span class="nn">G</span><span class="p">.</span><span class="n">erased</span> <span class="o">(</span><span class="kt">list</span> <span class="n">a</span><span class="o">))</span>
<span class="o">:</span> <span class="nc">GTot</span> <span class="nc">Type0</span> <span class="o">(</span><span class="n">decreases</span> <span class="o">(</span><span class="nn">G</span><span class="p">.</span><span class="n">reveal</span> <span class="n">l</span><span class="o">))</span>
<span class="o">=</span> <span class="nn">B</span><span class="p">.</span><span class="n">live</span> <span class="n">h</span> <span class="n">c</span> <span class="o">/\</span> <span class="o">(</span>
  <span class="k">match</span> <span class="nn">G</span><span class="p">.</span><span class="n">reveal</span> <span class="n">l</span> <span class="k">with</span>
  <span class="o">|</span> <span class="bp">[]</span> <span class="o">-&gt;</span>
    <span class="nn">B</span><span class="p">.</span><span class="n">g_is_null</span> <span class="n">c</span>
  <span class="o">|</span> <span class="n">a</span> <span class="o">::</span> <span class="n">q</span> <span class="o">-&gt;</span>
    <span class="nn">B</span><span class="p">.</span><span class="n">length</span> <span class="n">c</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">/\</span> <span class="o">(</span>
    <span class="kd">let</span> <span class="o">{</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="o">;</span> <span class="n">next</span><span class="o">=</span><span class="n">next</span> <span class="o">}</span> <span class="o">=</span> <span class="nn">B</span><span class="p">.</span><span class="n">get</span> <span class="n">h</span> <span class="n">c</span> <span class="mi">0</span> <span class="k">in</span>
    <span class="n">a</span> <span class="o">==</span> <span class="n">data</span> <span class="o">/\</span>
    <span class="n">well_formed</span> <span class="n">h</span> <span class="n">next</span> <span class="o">(</span><span class="nn">G</span><span class="p">.</span><span class="n">hide</span> <span class="n">q</span><span class="o">)</span>
  <span class="o">))</span>
</pre></div>
</div>
<p>Note: all the ghost predicates and functions operate on a length of type
nat; the Ghost effect guarantees that the length can only be used at
run-time. Functions called at run-time will, conversely, use a length of
type <cite>erased nat</cite>, which states that the length is
computationally-irrelevant and can be safely removed from the resulting C
code via a combination of F* + KaRaMeL erasure.</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="kd">let</span> <span class="kd">rec</span> <span class="n">length_functional</span> <span class="o">#</span><span class="n">a</span> <span class="o">(</span><span class="n">h</span><span class="o">:</span> <span class="nn">HS</span><span class="p">.</span><span class="n">mem</span><span class="o">)</span> <span class="o">(</span><span class="n">c</span><span class="o">:</span> <span class="n">t</span> <span class="n">a</span><span class="o">)</span> <span class="o">(</span><span class="n">l1</span> <span class="n">l2</span><span class="o">:</span> <span class="nn">G</span><span class="p">.</span><span class="n">erased</span> <span class="o">(</span><span class="kt">list</span> <span class="n">a</span><span class="o">)):</span>
  <span class="nc">Lemma</span>
    <span class="o">(</span><span class="k">requires</span> <span class="o">(</span><span class="n">well_formed</span> <span class="n">h</span> <span class="n">c</span> <span class="n">l1</span> <span class="o">/\</span> <span class="n">well_formed</span> <span class="n">h</span> <span class="n">c</span> <span class="n">l2</span><span class="o">))</span>
    <span class="o">(</span><span class="k">ensures</span> <span class="o">(</span><span class="n">l1</span> <span class="o">==</span> <span class="n">l2</span><span class="o">))</span>
    <span class="o">(</span><span class="n">decreases</span> <span class="o">(</span><span class="nn">G</span><span class="p">.</span><span class="n">reveal</span> <span class="n">l1</span><span class="o">))</span>
    <span class="o">[</span> <span class="nc">SMTPat</span> <span class="o">(</span><span class="n">well_formed</span> <span class="n">h</span> <span class="n">c</span> <span class="n">l1</span><span class="o">);</span> <span class="nc">SMTPat</span> <span class="o">(</span><span class="n">well_formed</span> <span class="n">h</span> <span class="n">c</span> <span class="n">l2</span><span class="o">)</span> <span class="o">]</span> <span class="o">=</span>
  <span class="k">if</span> <span class="nn">B</span><span class="p">.</span><span class="n">g_is_null</span> <span class="n">c</span>
  <span class="k">then</span> <span class="bp">()</span>
  <span class="k">else</span>
    <span class="kd">let</span> <span class="o">{</span> <span class="n">next</span><span class="o">=</span><span class="n">next</span> <span class="o">}</span> <span class="o">=</span> <span class="nn">B</span><span class="p">.</span><span class="n">get</span> <span class="n">h</span> <span class="n">c</span> <span class="mi">0</span> <span class="k">in</span>
    <span class="n">length_functional</span> <span class="n">h</span> <span class="n">next</span> <span class="o">(</span><span class="nn">G</span><span class="p">.</span><span class="n">hide</span> <span class="o">(</span><span class="nn">L</span><span class="p">.</span><span class="n">tl</span> <span class="o">(</span><span class="nn">G</span><span class="p">.</span><span class="n">reveal</span> <span class="n">l1</span><span class="o">)))</span> <span class="o">(</span><span class="nn">G</span><span class="p">.</span><span class="n">hide</span> <span class="o">(</span><span class="nn">L</span><span class="p">.</span><span class="n">tl</span> <span class="o">(</span><span class="nn">G</span><span class="p">.</span><span class="n">reveal</span> <span class="n">l2</span><span class="o">)))</span>
</pre></div>
</div>
<p>As we start proving some degree of functional correctness, we will have to
reason about non-interference, and state that some operations do not modify
the footprint of a given list.</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="o">#</span><span class="n">set</span><span class="o">-</span><span class="n">options</span> <span class="s2">&quot;--max_ifuel 1 --max_fuel 2&quot;</span>
<span class="k">val</span> <span class="n">footprint</span><span class="o">:</span> <span class="o">(#</span><span class="n">a</span><span class="o">:</span> <span class="nc">Type</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="n">h</span><span class="o">:</span> <span class="nn">HS</span><span class="p">.</span><span class="n">mem</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="n">l</span><span class="o">:</span> <span class="n">t</span> <span class="n">a</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="n">n</span><span class="o">:</span> <span class="nn">G</span><span class="p">.</span><span class="n">erased</span> <span class="o">(</span><span class="kt">list</span> <span class="n">a</span><span class="o">))</span> <span class="o">-&gt;</span> <span class="nc">Ghost</span> <span class="nn">MO</span><span class="p">.</span><span class="n">loc</span>
  <span class="o">(</span><span class="k">requires</span> <span class="o">(</span><span class="n">well_formed</span> <span class="n">h</span> <span class="n">l</span> <span class="n">n</span><span class="o">))</span>
  <span class="o">(</span><span class="k">ensures</span> <span class="o">(</span><span class="k">fun</span> <span class="n">refs</span> <span class="o">-&gt;</span> <span class="bp">True</span><span class="o">))</span>
  <span class="o">(</span><span class="n">decreases</span> <span class="o">(</span><span class="nn">G</span><span class="p">.</span><span class="n">reveal</span> <span class="n">n</span><span class="o">))</span>

<span class="kd">let</span> <span class="kd">rec</span> <span class="n">footprint</span> <span class="o">#</span><span class="n">a</span> <span class="n">h</span> <span class="n">l</span> <span class="n">n</span> <span class="o">=</span>
  <span class="k">if</span> <span class="nn">B</span><span class="p">.</span><span class="n">g_is_null</span> <span class="n">l</span>
  <span class="k">then</span> <span class="nn">MO</span><span class="p">.</span><span class="n">loc_none</span>
  <span class="k">else</span>
    <span class="kd">let</span> <span class="o">{</span><span class="n">next</span> <span class="o">=</span> <span class="n">next</span><span class="o">}</span> <span class="o">=</span> <span class="nn">B</span><span class="p">.</span><span class="n">get</span> <span class="n">h</span> <span class="n">l</span> <span class="mi">0</span> <span class="k">in</span>
    <span class="kd">let</span> <span class="n">refs</span> <span class="o">=</span> <span class="n">footprint</span> <span class="n">h</span> <span class="n">next</span> <span class="o">(</span><span class="nn">G</span><span class="p">.</span><span class="n">hide</span> <span class="o">(</span><span class="nn">L</span><span class="p">.</span><span class="n">tl</span> <span class="o">(</span><span class="nn">G</span><span class="p">.</span><span class="n">reveal</span> <span class="n">n</span><span class="o">)))</span> <span class="k">in</span>
    <span class="nn">MO</span><span class="p">.</span><span class="n">loc_union</span> <span class="o">(</span><span class="nn">MO</span><span class="p">.</span><span class="n">loc_buffer</span> <span class="n">l</span><span class="o">)</span> <span class="n">refs</span>
<span class="o">#</span><span class="n">reset</span><span class="o">-</span><span class="n">options</span>

<span class="kd">let</span> <span class="kd">rec</span> <span class="n">modifies_disjoint_footprint</span>
  <span class="o">(#</span><span class="n">a</span><span class="o">:</span> <span class="nc">Type</span><span class="o">)</span>
  <span class="o">(</span><span class="n">h</span><span class="o">:</span> <span class="nn">HS</span><span class="p">.</span><span class="n">mem</span><span class="o">)</span>
  <span class="o">(</span><span class="n">l</span><span class="o">:</span> <span class="n">t</span> <span class="n">a</span><span class="o">)</span>
  <span class="o">(</span><span class="n">n</span><span class="o">:</span> <span class="nn">G</span><span class="p">.</span><span class="n">erased</span> <span class="o">(</span><span class="kt">list</span> <span class="n">a</span><span class="o">))</span>
  <span class="o">(</span><span class="n">r</span><span class="o">:</span> <span class="nn">MO</span><span class="p">.</span><span class="n">loc</span><span class="o">)</span>
  <span class="o">(</span><span class="n">h&#39;</span> <span class="o">:</span> <span class="nn">HS</span><span class="p">.</span><span class="n">mem</span><span class="o">)</span>
<span class="o">:</span> <span class="nc">Lemma</span>
  <span class="o">(</span><span class="k">requires</span> <span class="o">(</span>
    <span class="n">well_formed</span> <span class="n">h</span> <span class="n">l</span> <span class="n">n</span> <span class="o">/\</span>
    <span class="nn">MO</span><span class="p">.</span><span class="n">loc_disjoint</span> <span class="n">r</span> <span class="o">(</span><span class="n">footprint</span> <span class="n">h</span> <span class="n">l</span> <span class="n">n</span><span class="o">)</span> <span class="o">/\</span>
    <span class="nn">MO</span><span class="p">.</span><span class="n">modifies</span> <span class="n">r</span> <span class="n">h</span> <span class="n">h&#39;</span>
  <span class="o">))</span>
  <span class="o">(</span><span class="k">ensures</span> <span class="o">(</span>
    <span class="n">well_formed</span> <span class="n">h&#39;</span> <span class="n">l</span> <span class="n">n</span> <span class="o">/\</span>
    <span class="n">footprint</span> <span class="n">h&#39;</span> <span class="n">l</span> <span class="n">n</span> <span class="o">==</span> <span class="n">footprint</span> <span class="n">h</span> <span class="n">l</span> <span class="n">n</span>
  <span class="o">))</span>
  <span class="o">(</span><span class="n">decreases</span> <span class="o">(</span><span class="nn">G</span><span class="p">.</span><span class="n">reveal</span> <span class="n">n</span><span class="o">))</span>
<span class="o">=</span> <span class="k">if</span> <span class="nn">B</span><span class="p">.</span><span class="n">g_is_null</span> <span class="n">l</span>
  <span class="k">then</span> <span class="bp">()</span>
  <span class="k">else</span> <span class="n">begin</span>
    <span class="kd">let</span> <span class="o">{</span><span class="n">next</span> <span class="o">=</span> <span class="n">l&#39;</span><span class="o">}</span> <span class="o">=</span> <span class="nn">B</span><span class="p">.</span><span class="n">get</span> <span class="n">h</span> <span class="n">l</span> <span class="mi">0</span> <span class="k">in</span>
    <span class="n">modifies_disjoint_footprint</span> <span class="n">h</span> <span class="n">l&#39;</span> <span class="o">(</span><span class="nn">G</span><span class="p">.</span><span class="n">hide</span> <span class="o">(</span><span class="nn">L</span><span class="p">.</span><span class="n">tl</span> <span class="o">(</span><span class="nn">G</span><span class="p">.</span><span class="n">reveal</span> <span class="n">n</span><span class="o">)))</span> <span class="n">r</span> <span class="n">h&#39;</span>
  <span class="k">end</span>

<span class="kd">let</span> <span class="kd">rec</span> <span class="n">well_formed_distinct_lengths_disjoint</span>
  <span class="o">#</span><span class="n">a</span>
  <span class="o">(</span><span class="n">c1</span><span class="o">:</span> <span class="nn">B</span><span class="p">.</span><span class="n">pointer</span> <span class="o">(</span><span class="n">cell</span> <span class="n">a</span><span class="o">))</span>
  <span class="o">(</span><span class="n">c2</span><span class="o">:</span> <span class="nn">B</span><span class="p">.</span><span class="n">pointer</span> <span class="o">(</span><span class="n">cell</span> <span class="n">a</span><span class="o">))</span>
  <span class="o">(</span><span class="n">n1</span><span class="o">:</span> <span class="nn">G</span><span class="p">.</span><span class="n">erased</span> <span class="o">(</span><span class="kt">list</span> <span class="n">a</span><span class="o">))</span>
  <span class="o">(</span><span class="n">n2</span><span class="o">:</span> <span class="nn">G</span><span class="p">.</span><span class="n">erased</span> <span class="o">(</span><span class="kt">list</span> <span class="n">a</span><span class="o">))</span>
  <span class="o">(</span><span class="n">h</span><span class="o">:</span> <span class="nn">HS</span><span class="p">.</span><span class="n">mem</span><span class="o">)</span>
<span class="o">:</span> <span class="nc">Lemma</span>
  <span class="o">(</span><span class="k">requires</span> <span class="o">(</span>
    <span class="n">well_formed</span> <span class="n">h</span> <span class="n">c1</span> <span class="n">n1</span> <span class="o">/\</span>
    <span class="n">well_formed</span> <span class="n">h</span> <span class="n">c2</span> <span class="n">n2</span> <span class="o">/\</span>
    <span class="nn">L</span><span class="p">.</span><span class="n">length</span> <span class="o">(</span><span class="nn">G</span><span class="p">.</span><span class="n">reveal</span> <span class="n">n1</span><span class="o">)</span> <span class="o">&lt;&gt;</span> <span class="nn">L</span><span class="p">.</span><span class="n">length</span> <span class="o">(</span><span class="nn">G</span><span class="p">.</span><span class="n">reveal</span> <span class="n">n2</span><span class="o">)</span>
  <span class="o">))</span>
  <span class="o">(</span><span class="k">ensures</span> <span class="o">(</span>
    <span class="nn">B</span><span class="p">.</span><span class="n">disjoint</span> <span class="n">c1</span> <span class="n">c2</span>
  <span class="o">))</span>
  <span class="o">(</span><span class="n">decreases</span> <span class="o">(</span><span class="nn">L</span><span class="p">.</span><span class="n">length</span> <span class="o">(</span><span class="nn">G</span><span class="p">.</span><span class="n">reveal</span> <span class="n">n1</span><span class="o">)</span> <span class="o">+</span> <span class="nn">L</span><span class="p">.</span><span class="n">length</span> <span class="o">(</span><span class="nn">G</span><span class="p">.</span><span class="n">reveal</span> <span class="n">n2</span><span class="o">)))</span>
<span class="o">=</span> <span class="kd">let</span> <span class="o">{</span><span class="n">next</span> <span class="o">=</span> <span class="n">next1</span><span class="o">}</span> <span class="o">=</span> <span class="nn">B</span><span class="p">.</span><span class="n">get</span> <span class="n">h</span> <span class="n">c1</span> <span class="mi">0</span> <span class="k">in</span>
  <span class="kd">let</span> <span class="o">{</span><span class="n">next</span> <span class="o">=</span> <span class="n">next2</span><span class="o">}</span> <span class="o">=</span> <span class="nn">B</span><span class="p">.</span><span class="n">get</span> <span class="n">h</span> <span class="n">c2</span> <span class="mi">0</span> <span class="k">in</span>
  <span class="kd">let</span> <span class="n">f</span> <span class="bp">()</span> <span class="o">:</span> <span class="nc">Lemma</span> <span class="o">(</span><span class="n">next1</span> <span class="o">=!=</span> <span class="n">next2</span><span class="o">)</span> <span class="o">=</span>
    <span class="k">if</span> <span class="nn">B</span><span class="p">.</span><span class="n">g_is_null</span> <span class="n">next1</span> <span class="o">||</span> <span class="nn">B</span><span class="p">.</span><span class="n">g_is_null</span> <span class="n">next2</span>
    <span class="k">then</span> <span class="bp">()</span>
    <span class="k">else</span>
      <span class="n">well_formed_distinct_lengths_disjoint</span> <span class="n">next1</span> <span class="n">next2</span> <span class="o">(</span><span class="nn">G</span><span class="p">.</span><span class="n">hide</span> <span class="o">(</span><span class="nn">L</span><span class="p">.</span><span class="n">tl</span> <span class="o">(</span><span class="nn">G</span><span class="p">.</span><span class="n">reveal</span> <span class="n">n1</span><span class="o">)))</span> <span class="o">(</span><span class="nn">G</span><span class="p">.</span><span class="n">hide</span> <span class="o">(</span><span class="nn">L</span><span class="p">.</span><span class="n">tl</span> <span class="o">(</span><span class="nn">G</span><span class="p">.</span><span class="n">reveal</span> <span class="n">n2</span><span class="o">)))</span> <span class="n">h</span>
  <span class="k">in</span>
  <span class="n">f</span> <span class="bp">()</span><span class="o">;</span>
  <span class="nn">B</span><span class="p">.</span><span class="n">pointer_distinct_sel_disjoint</span> <span class="n">c1</span> <span class="n">c2</span> <span class="n">h</span>

<span class="kd">let</span> <span class="kd">rec</span> <span class="n">well_formed_gt_lengths_disjoint_from_list</span>
  <span class="o">#</span><span class="n">a</span>
  <span class="o">(</span><span class="n">h</span><span class="o">:</span> <span class="nn">HS</span><span class="p">.</span><span class="n">mem</span><span class="o">)</span>
  <span class="o">(</span><span class="n">c1</span><span class="o">:</span> <span class="nn">B</span><span class="p">.</span><span class="n">pointer_or_null</span> <span class="o">(</span><span class="n">cell</span> <span class="n">a</span><span class="o">))</span>
  <span class="o">(</span><span class="n">c2</span><span class="o">:</span> <span class="nn">B</span><span class="p">.</span><span class="n">pointer_or_null</span> <span class="o">(</span><span class="n">cell</span> <span class="n">a</span><span class="o">))</span>
  <span class="o">(</span><span class="n">n1</span><span class="o">:</span> <span class="nn">G</span><span class="p">.</span><span class="n">erased</span> <span class="o">(</span><span class="kt">list</span> <span class="n">a</span><span class="o">))</span>
  <span class="o">(</span><span class="n">n2</span><span class="o">:</span> <span class="nn">G</span><span class="p">.</span><span class="n">erased</span> <span class="o">(</span><span class="kt">list</span> <span class="n">a</span><span class="o">))</span>
<span class="o">:</span> <span class="nc">Lemma</span>
  <span class="o">(</span><span class="k">requires</span> <span class="o">(</span><span class="n">well_formed</span> <span class="n">h</span> <span class="n">c1</span> <span class="n">n1</span> <span class="o">/\</span> <span class="n">well_formed</span> <span class="n">h</span> <span class="n">c2</span> <span class="n">n2</span> <span class="o">/\</span> <span class="nn">L</span><span class="p">.</span><span class="n">length</span> <span class="o">(</span><span class="nn">G</span><span class="p">.</span><span class="n">reveal</span> <span class="n">n1</span><span class="o">)</span> <span class="o">&gt;</span> <span class="nn">L</span><span class="p">.</span><span class="n">length</span> <span class="o">(</span><span class="nn">G</span><span class="p">.</span><span class="n">reveal</span> <span class="n">n2</span><span class="o">)))</span>
  <span class="o">(</span><span class="k">ensures</span> <span class="o">(</span><span class="nn">MO</span><span class="p">.</span><span class="n">loc_disjoint</span> <span class="o">(</span><span class="nn">MO</span><span class="p">.</span><span class="n">loc_buffer</span> <span class="n">c1</span><span class="o">)</span> <span class="o">(</span><span class="n">footprint</span> <span class="n">h</span> <span class="n">c2</span> <span class="n">n2</span><span class="o">)))</span>
  <span class="o">(</span><span class="n">decreases</span> <span class="o">(</span><span class="nn">G</span><span class="p">.</span><span class="n">reveal</span> <span class="n">n2</span><span class="o">))</span>
<span class="o">=</span> <span class="k">match</span> <span class="nn">G</span><span class="p">.</span><span class="n">reveal</span> <span class="n">n2</span> <span class="k">with</span>
  <span class="o">|</span> <span class="bp">[]</span> <span class="o">-&gt;</span> <span class="bp">()</span>
  <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span>
    <span class="n">well_formed_distinct_lengths_disjoint</span> <span class="n">c1</span> <span class="n">c2</span> <span class="n">n1</span> <span class="n">n2</span> <span class="n">h</span><span class="o">;</span>
    <span class="n">well_formed_gt_lengths_disjoint_from_list</span> <span class="n">h</span> <span class="n">c1</span> <span class="o">(</span><span class="nn">B</span><span class="p">.</span><span class="n">get</span> <span class="n">h</span> <span class="n">c2</span> <span class="mi">0</span><span class="o">).</span><span class="n">next</span> <span class="n">n1</span> <span class="o">(</span><span class="nn">G</span><span class="p">.</span><span class="n">hide</span> <span class="o">(</span><span class="nn">L</span><span class="p">.</span><span class="n">tl</span> <span class="o">(</span><span class="nn">G</span><span class="p">.</span><span class="n">reveal</span> <span class="n">n2</span><span class="o">)))</span>

<span class="kd">let</span> <span class="n">well_formed_head_tail_disjoint</span>
  <span class="o">(#</span><span class="n">a</span><span class="o">:</span> <span class="nc">Type</span><span class="o">)</span>
  <span class="o">(</span><span class="n">h</span><span class="o">:</span> <span class="nn">HS</span><span class="p">.</span><span class="n">mem</span><span class="o">)</span>
  <span class="o">(</span><span class="n">c</span><span class="o">:</span> <span class="nn">B</span><span class="p">.</span><span class="n">pointer</span> <span class="o">(</span><span class="n">cell</span> <span class="n">a</span><span class="o">))</span>
  <span class="o">(</span><span class="n">n</span><span class="o">:</span> <span class="nn">G</span><span class="p">.</span><span class="n">erased</span> <span class="o">(</span><span class="kt">list</span> <span class="n">a</span><span class="o">))</span>
<span class="o">:</span> <span class="nc">Lemma</span>
  <span class="o">(</span><span class="k">requires</span> <span class="o">(</span><span class="n">well_formed</span> <span class="n">h</span> <span class="n">c</span> <span class="n">n</span><span class="o">))</span>
  <span class="o">(</span><span class="k">ensures</span> <span class="o">(</span>
    <span class="nn">MO</span><span class="p">.</span><span class="n">loc_disjoint</span> <span class="o">(</span><span class="nn">MO</span><span class="p">.</span><span class="n">loc_buffer</span> <span class="n">c</span><span class="o">)</span> <span class="o">(</span><span class="n">footprint</span> <span class="n">h</span> <span class="o">(</span><span class="nn">B</span><span class="p">.</span><span class="n">get</span> <span class="n">h</span> <span class="n">c</span> <span class="mi">0</span><span class="o">).</span><span class="n">next</span> <span class="o">(</span><span class="nn">G</span><span class="p">.</span><span class="n">hide</span> <span class="o">(</span><span class="nn">L</span><span class="p">.</span><span class="n">tl</span> <span class="o">(</span><span class="nn">G</span><span class="p">.</span><span class="n">reveal</span> <span class="n">n</span><span class="o">))))</span>
  <span class="o">))</span>
<span class="o">=</span> <span class="n">well_formed_gt_lengths_disjoint_from_list</span> <span class="n">h</span> <span class="n">c</span> <span class="o">(</span><span class="nn">B</span><span class="p">.</span><span class="n">get</span> <span class="n">h</span> <span class="n">c</span> <span class="mi">0</span><span class="o">).</span><span class="n">next</span> <span class="n">n</span> <span class="o">(</span><span class="nn">G</span><span class="p">.</span><span class="n">hide</span> <span class="o">(</span><span class="nn">L</span><span class="p">.</span><span class="n">tl</span> <span class="o">(</span><span class="nn">G</span><span class="p">.</span><span class="n">reveal</span> <span class="n">n</span><span class="o">)))</span>

<span class="kd">let</span> <span class="kd">rec</span> <span class="n">unused_in_well_formed_disjoint_from_list</span>
  <span class="o">#</span><span class="n">a</span> <span class="o">#</span><span class="n">b</span>
  <span class="o">(</span><span class="n">h</span><span class="o">:</span> <span class="nn">HS</span><span class="p">.</span><span class="n">mem</span><span class="o">)</span>
  <span class="o">(</span><span class="n">r</span><span class="o">:</span> <span class="nn">B</span><span class="p">.</span><span class="n">buffer</span> <span class="n">a</span><span class="o">)</span>
  <span class="o">(</span><span class="n">l</span><span class="o">:</span> <span class="nn">B</span><span class="p">.</span><span class="n">pointer_or_null</span> <span class="o">(</span><span class="n">cell</span> <span class="n">b</span><span class="o">))</span>
  <span class="o">(</span><span class="n">n</span><span class="o">:</span> <span class="nn">G</span><span class="p">.</span><span class="n">erased</span> <span class="o">(</span><span class="kt">list</span> <span class="n">b</span><span class="o">))</span>
<span class="o">:</span> <span class="nc">Lemma</span>
  <span class="o">(</span><span class="k">requires</span> <span class="o">(</span><span class="n">r</span> <span class="ow">`B.unused_in`</span> <span class="n">h</span> <span class="o">/\</span> <span class="n">well_formed</span> <span class="n">h</span> <span class="n">l</span> <span class="n">n</span><span class="o">))</span>
  <span class="o">(</span><span class="k">ensures</span> <span class="o">(</span><span class="nn">MO</span><span class="p">.</span><span class="n">loc_disjoint</span> <span class="o">(</span><span class="nn">MO</span><span class="p">.</span><span class="n">loc_buffer</span> <span class="n">r</span><span class="o">)</span> <span class="o">(</span><span class="n">footprint</span> <span class="n">h</span> <span class="n">l</span> <span class="n">n</span><span class="o">)))</span>
  <span class="o">(</span><span class="n">decreases</span> <span class="o">(</span><span class="nn">G</span><span class="p">.</span><span class="n">reveal</span> <span class="n">n</span><span class="o">))</span>
<span class="o">=</span> <span class="k">match</span> <span class="nn">G</span><span class="p">.</span><span class="n">reveal</span> <span class="n">n</span> <span class="k">with</span>
  <span class="o">|</span> <span class="bp">[]</span> <span class="o">-&gt;</span> <span class="bp">()</span>
  <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">unused_in_well_formed_disjoint_from_list</span> <span class="n">h</span> <span class="n">r</span> <span class="o">(</span><span class="nn">B</span><span class="p">.</span><span class="n">get</span> <span class="n">h</span> <span class="n">l</span> <span class="mi">0</span><span class="o">).</span><span class="n">next</span> <span class="o">(</span><span class="nn">G</span><span class="p">.</span><span class="n">hide</span> <span class="o">(</span><span class="nn">L</span><span class="p">.</span><span class="n">tl</span> <span class="o">(</span><span class="nn">G</span><span class="p">.</span><span class="n">reveal</span> <span class="n">n</span><span class="o">)))</span>
</pre></div>
</div>
<p>Finally, the pop operation. Here we use the classic representation
using null pointers, which requires the client to pass a pointer
to a pointer, which is then filled with the address of the next
cell, or null if this was the last element in the list.</p>
<p>The code is straightforward and crucially relies on the call to the lemma
above. Note that at this stage we do not prove full functional correctness
of our implementation. Rather, we just state that the lengths is as
expected.</p>
<p>This version uses an erased integer n; we have to work a little bit to
hide/reveal the computationally-irrelevant length.</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">pop</span><span class="o">:</span> <span class="o">(#</span><span class="n">a</span><span class="o">:</span> <span class="nc">Type</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">(#</span><span class="n">n</span><span class="o">:</span> <span class="nn">G</span><span class="p">.</span><span class="n">erased</span> <span class="o">(</span><span class="kt">list</span> <span class="n">a</span><span class="o">))</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="n">pl</span><span class="o">:</span> <span class="nn">B</span><span class="p">.</span><span class="n">pointer</span> <span class="o">(</span><span class="n">t</span> <span class="n">a</span><span class="o">))</span> <span class="o">-&gt;</span>
  <span class="nc">Stack</span> <span class="n">a</span>
  <span class="o">(</span><span class="k">requires</span> <span class="o">(</span><span class="k">fun</span> <span class="n">h</span> <span class="o">-&gt;</span>
    <span class="kd">let</span> <span class="n">l</span> <span class="o">=</span> <span class="nn">B</span><span class="p">.</span><span class="n">get</span> <span class="n">h</span> <span class="n">pl</span> <span class="mi">0</span> <span class="k">in</span>
    <span class="nn">B</span><span class="p">.</span><span class="n">live</span> <span class="n">h</span> <span class="n">pl</span> <span class="o">/\</span>
    <span class="n">well_formed</span> <span class="n">h</span> <span class="n">l</span> <span class="n">n</span> <span class="o">/\</span>
    <span class="nn">MO</span><span class="p">.</span><span class="n">loc_disjoint</span> <span class="o">(</span><span class="nn">MO</span><span class="p">.</span><span class="n">loc_buffer</span> <span class="n">pl</span><span class="o">)</span> <span class="o">(</span><span class="n">footprint</span> <span class="n">h</span> <span class="n">l</span> <span class="n">n</span><span class="o">)</span> <span class="o">/\</span>
    <span class="nc">Cons</span><span class="o">?</span> <span class="o">(</span><span class="nn">G</span><span class="p">.</span><span class="n">reveal</span> <span class="n">n</span><span class="o">)</span>
  <span class="o">))</span>
  <span class="o">(</span><span class="k">ensures</span> <span class="o">(</span><span class="k">fun</span> <span class="n">h0</span> <span class="n">v</span> <span class="n">h1</span> <span class="o">-&gt;</span>
    <span class="kd">let</span> <span class="n">l</span> <span class="o">=</span> <span class="nn">B</span><span class="p">.</span><span class="n">get</span> <span class="n">h1</span> <span class="n">pl</span> <span class="mi">0</span> <span class="k">in</span>
    <span class="kd">let</span> <span class="n">n&#39;</span> <span class="o">=</span> <span class="nn">G</span><span class="p">.</span><span class="n">hide</span> <span class="o">(</span><span class="nn">L</span><span class="p">.</span><span class="n">tl</span> <span class="o">(</span><span class="nn">G</span><span class="p">.</span><span class="n">reveal</span> <span class="n">n</span><span class="o">))</span> <span class="k">in</span>
    <span class="nn">B</span><span class="p">.</span><span class="n">live</span> <span class="n">h1</span> <span class="n">pl</span> <span class="o">/\</span>
    <span class="nn">MO</span><span class="p">.</span><span class="n">modifies</span> <span class="o">(</span><span class="nn">MO</span><span class="p">.</span><span class="n">loc_buffer</span> <span class="n">pl</span><span class="o">)</span> <span class="n">h0</span> <span class="n">h1</span> <span class="o">/\</span>
    <span class="n">well_formed</span> <span class="n">h1</span> <span class="n">l</span> <span class="n">n&#39;</span> <span class="o">/\</span>
    <span class="nn">MO</span><span class="p">.</span><span class="n">loc_disjoint</span> <span class="o">(</span><span class="nn">MO</span><span class="p">.</span><span class="n">loc_buffer</span> <span class="n">pl</span><span class="o">)</span> <span class="o">(</span><span class="n">footprint</span> <span class="n">h1</span> <span class="n">l</span> <span class="n">n&#39;</span><span class="o">)</span>
  <span class="o">))</span>

<span class="kd">let</span> <span class="n">pop</span> <span class="o">#</span><span class="n">a</span> <span class="o">#</span><span class="n">n</span> <span class="n">pl</span> <span class="o">=</span>
  <span class="kd">let</span> <span class="n">l</span> <span class="o">=</span> <span class="o">!*</span> <span class="n">pl</span> <span class="k">in</span>
  <span class="kd">let</span> <span class="n">lcell</span> <span class="o">=</span> <span class="o">!*</span> <span class="n">l</span> <span class="k">in</span>
  <span class="kd">let</span> <span class="n">h0</span> <span class="o">=</span> <span class="n">get</span> <span class="bp">()</span> <span class="k">in</span>
  <span class="n">pl</span> <span class="o">*=</span> <span class="n">lcell</span><span class="o">.</span><span class="n">next</span><span class="o">;</span>
  <span class="kd">let</span> <span class="n">h1</span> <span class="o">=</span> <span class="n">get</span> <span class="bp">()</span> <span class="k">in</span>
  <span class="n">well_formed_head_tail_disjoint</span> <span class="n">h0</span> <span class="n">l</span> <span class="n">n</span><span class="o">;</span>
  <span class="n">modifies_disjoint_footprint</span> <span class="n">h0</span> <span class="n">l</span> <span class="n">n</span> <span class="o">(</span><span class="nn">MO</span><span class="p">.</span><span class="n">loc_buffer</span> <span class="n">pl</span><span class="o">)</span> <span class="n">h1</span><span class="o">;</span>
  <span class="n">lcell</span><span class="o">.</span><span class="n">data</span>

<span class="k">val</span> <span class="n">push</span><span class="o">:</span> <span class="o">(#</span><span class="n">a</span><span class="o">:</span> <span class="nc">Type</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">(#</span><span class="n">n</span><span class="o">:</span> <span class="nn">G</span><span class="p">.</span><span class="n">erased</span> <span class="o">(</span><span class="kt">list</span> <span class="n">a</span><span class="o">))</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="n">pl</span><span class="o">:</span> <span class="nn">B</span><span class="p">.</span><span class="n">pointer</span> <span class="o">(</span><span class="n">t</span> <span class="n">a</span><span class="o">))</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="n">x</span><span class="o">:</span> <span class="n">a</span><span class="o">)</span> <span class="o">-&gt;</span>
  <span class="nc">ST</span> <span class="kt">unit</span>
    <span class="o">(</span><span class="k">requires</span> <span class="o">(</span><span class="k">fun</span> <span class="n">h</span> <span class="o">-&gt;</span>
      <span class="kd">let</span> <span class="n">l</span> <span class="o">=</span> <span class="nn">B</span><span class="p">.</span><span class="n">get</span> <span class="n">h</span> <span class="n">pl</span> <span class="mi">0</span> <span class="k">in</span>
      <span class="nn">B</span><span class="p">.</span><span class="n">live</span> <span class="n">h</span> <span class="n">pl</span> <span class="o">/\</span>
      <span class="n">well_formed</span> <span class="n">h</span> <span class="n">l</span> <span class="n">n</span> <span class="o">/\</span>
      <span class="nn">MO</span><span class="p">.</span><span class="n">loc_disjoint</span> <span class="o">(</span><span class="nn">MO</span><span class="p">.</span><span class="n">loc_buffer</span> <span class="n">pl</span><span class="o">)</span> <span class="o">(</span><span class="n">footprint</span> <span class="n">h</span> <span class="n">l</span> <span class="n">n</span><span class="o">)</span>
    <span class="o">))</span>
    <span class="o">(</span><span class="k">ensures</span> <span class="o">(</span><span class="k">fun</span> <span class="n">h0</span> <span class="n">_</span> <span class="n">h1</span> <span class="o">-&gt;</span>
      <span class="kd">let</span> <span class="n">n&#39;</span> <span class="o">=</span> <span class="nn">G</span><span class="p">.</span><span class="n">hide</span> <span class="o">(</span><span class="n">x</span> <span class="o">::</span> <span class="nn">G</span><span class="p">.</span><span class="n">reveal</span> <span class="n">n</span><span class="o">)</span> <span class="k">in</span>
      <span class="kd">let</span> <span class="n">l</span> <span class="o">=</span> <span class="nn">B</span><span class="p">.</span><span class="n">get</span> <span class="n">h1</span> <span class="n">pl</span> <span class="mi">0</span> <span class="k">in</span>
      <span class="nn">MO</span><span class="p">.</span><span class="n">modifies</span> <span class="o">(</span><span class="nn">MO</span><span class="p">.</span><span class="n">loc_buffer</span> <span class="n">pl</span><span class="o">)</span> <span class="n">h0</span> <span class="n">h1</span> <span class="o">/\</span>
      <span class="nn">B</span><span class="p">.</span><span class="n">live</span> <span class="n">h1</span> <span class="n">pl</span> <span class="o">/\</span>
      <span class="n">well_formed</span> <span class="n">h1</span> <span class="n">l</span> <span class="n">n&#39;</span> <span class="o">/\</span>
      <span class="nn">MO</span><span class="p">.</span><span class="n">loc_disjoint</span> <span class="o">(</span><span class="nn">MO</span><span class="p">.</span><span class="n">loc_buffer</span> <span class="n">pl</span><span class="o">)</span> <span class="o">(</span><span class="n">footprint</span> <span class="n">h1</span> <span class="n">l</span> <span class="n">n&#39;</span><span class="o">)</span>
    <span class="o">))</span>

<span class="kd">let</span> <span class="n">push</span> <span class="o">#</span><span class="n">a</span> <span class="o">#</span><span class="n">n</span> <span class="n">pl</span> <span class="n">x</span> <span class="o">=</span>
  <span class="kd">let</span> <span class="n">h0</span> <span class="o">=</span> <span class="n">get</span> <span class="bp">()</span> <span class="k">in</span>
  <span class="kd">let</span> <span class="n">l</span> <span class="o">=</span> <span class="o">!*</span> <span class="n">pl</span> <span class="k">in</span>
  <span class="kd">let</span> <span class="n">c</span> <span class="o">=</span> <span class="o">{</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">x</span><span class="o">;</span>
    <span class="n">next</span> <span class="o">=</span> <span class="n">l</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="k">in</span>
  <span class="kd">let</span> <span class="n">pc</span><span class="o">:</span> <span class="nn">B</span><span class="p">.</span><span class="n">pointer</span> <span class="o">(</span><span class="n">cell</span> <span class="n">a</span><span class="o">)</span> <span class="o">=</span> <span class="nn">B</span><span class="p">.</span><span class="n">malloc</span> <span class="nn">HS</span><span class="p">.</span><span class="n">root</span> <span class="n">c</span> <span class="mi">1</span><span class="n">ul</span> <span class="k">in</span>
  <span class="n">unused_in_well_formed_disjoint_from_list</span> <span class="n">h0</span> <span class="n">pc</span> <span class="n">l</span> <span class="n">n</span><span class="o">;</span>
  <span class="kd">let</span> <span class="n">h1</span> <span class="o">=</span> <span class="n">get</span> <span class="bp">()</span> <span class="k">in</span>
  <span class="n">modifies_disjoint_footprint</span> <span class="n">h0</span> <span class="n">l</span> <span class="n">n</span> <span class="o">(</span><span class="nn">MO</span><span class="p">.</span><span class="n">loc_buffer</span> <span class="n">pc</span><span class="o">)</span> <span class="n">h1</span><span class="o">;</span>
  <span class="n">pl</span> <span class="o">*=</span> <span class="n">pc</span><span class="o">;</span>
  <span class="kd">let</span> <span class="n">h2</span> <span class="o">=</span> <span class="n">get</span> <span class="bp">()</span> <span class="k">in</span>
  <span class="n">modifies_disjoint_footprint</span> <span class="n">h1</span> <span class="n">l</span> <span class="n">n</span> <span class="o">(</span><span class="nn">MO</span><span class="p">.</span><span class="n">loc_buffer</span> <span class="n">pl</span><span class="o">)</span> <span class="n">h2</span>
</pre></div>
</div>
<p>Connecting our predicate <cite>well_formed</cite> to the regular length function.
Note that this function takes a list whose length is unknown statically,
because of the existential quantification.</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">length</span> <span class="o">(#</span><span class="n">a</span><span class="o">:</span> <span class="nc">Type</span><span class="o">)</span> <span class="o">(</span><span class="n">gn</span><span class="o">:</span> <span class="nn">G</span><span class="p">.</span><span class="n">erased</span> <span class="o">(</span><span class="kt">list</span> <span class="n">a</span><span class="o">))</span> <span class="o">(</span><span class="n">l</span><span class="o">:</span> <span class="n">t</span> <span class="n">a</span><span class="o">):</span> <span class="nc">Stack</span> <span class="nn">UInt32</span><span class="p">.</span><span class="n">t</span>
  <span class="o">(</span><span class="k">requires</span> <span class="o">(</span><span class="k">fun</span> <span class="n">h</span> <span class="o">-&gt;</span> <span class="n">well_formed</span> <span class="n">h</span> <span class="n">l</span> <span class="n">gn</span><span class="o">))</span>
  <span class="o">(</span><span class="k">ensures</span> <span class="o">(</span><span class="k">fun</span> <span class="n">h0</span> <span class="n">n</span> <span class="n">h1</span> <span class="o">-&gt;</span>
    <span class="n">h0</span> <span class="o">==</span> <span class="n">h1</span> <span class="o">/\</span>
    <span class="nn">U32</span><span class="p">.</span><span class="n">v</span> <span class="n">n</span> <span class="o">=</span> <span class="nn">L</span><span class="p">.</span><span class="n">length</span> <span class="o">(</span><span class="nn">G</span><span class="p">.</span><span class="n">reveal</span> <span class="n">gn</span><span class="o">)</span>
  <span class="o">))</span>
</pre></div>
</div>
<p>Note that we could have as easily returned an option, but sometimes fatal
errors are just easier to handle for client code. The <cite>C.String</cite> module
provides facilities for dealing with constant C string literals. It reveals
that they are zero-terminated and allows looping over them if one wants to,
say, copy an immutable constant string into a mutable buffer.</p>
<div class="highlight-fstar notranslate"><div class="highlight"><pre><span></span><span class="kd">let</span> <span class="kd">rec</span> <span class="n">length</span> <span class="o">#</span><span class="n">a</span> <span class="n">gn</span> <span class="n">l</span> <span class="o">=</span>
  <span class="k">if</span> <span class="nn">B</span><span class="p">.</span><span class="n">is_null</span> <span class="n">l</span>
  <span class="k">then</span> <span class="mi">0</span><span class="n">ul</span>
  <span class="k">else</span>
    <span class="kd">let</span> <span class="k">open</span> <span class="nc">U32</span> <span class="k">in</span>
    <span class="kd">let</span> <span class="n">c</span> <span class="o">=</span> <span class="o">!*</span> <span class="n">l</span> <span class="k">in</span>
    <span class="kd">let</span> <span class="n">next</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">next</span> <span class="k">in</span>
    <span class="kd">let</span> <span class="n">n</span> <span class="o">=</span> <span class="n">length</span> <span class="o">(</span><span class="nn">G</span><span class="p">.</span><span class="n">hide</span> <span class="o">(</span><span class="nn">L</span><span class="p">.</span><span class="n">tail</span> <span class="o">(</span><span class="nn">G</span><span class="p">.</span><span class="n">reveal</span> <span class="n">gn</span><span class="o">)))</span> <span class="n">next</span> <span class="k">in</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="n">ul</span> <span class="k">then</span> <span class="n">begin</span>
      <span class="nn">C</span><span class="p">.</span><span class="nn">String</span><span class="p">.</span><span class="o">(</span><span class="n">print</span> <span class="o">!$</span><span class="s2">&quot;Integer overflow while computing length&quot;</span><span class="o">);</span>
      <span class="nn">C</span><span class="p">.</span><span class="n">exit</span> <span class="mi">255</span><span class="n">l</span><span class="o">;</span>
      <span class="mi">0</span><span class="n">ul</span> <span class="c">// dummy return value, this point is unreachable</span>
    <span class="k">end</span> <span class="k">else</span>
      <span class="n">n</span> <span class="o">+^</span> <span class="mi">1</span><span class="n">ul</span>

<span class="k">val</span> <span class="n">main</span><span class="o">:</span> <span class="kt">unit</span> <span class="o">-&gt;</span> <span class="nc">ST</span> <span class="o">(</span><span class="nn">Int32</span><span class="p">.</span><span class="n">t</span><span class="o">)</span> <span class="o">(</span><span class="k">fun</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="bp">true</span><span class="o">)</span> <span class="o">(</span><span class="k">fun</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="bp">true</span><span class="o">)</span>

<span class="kd">let</span> <span class="n">main</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="kd">let</span> <span class="n">l</span><span class="o">:</span> <span class="nn">B</span><span class="p">.</span><span class="n">pointer_or_null</span> <span class="o">(</span><span class="n">t</span> <span class="nn">Int32</span><span class="p">.</span><span class="n">t</span><span class="o">)</span> <span class="o">=</span> <span class="nn">B</span><span class="p">.</span><span class="n">malloc</span> <span class="nn">HS</span><span class="p">.</span><span class="n">root</span> <span class="nn">B</span><span class="p">.</span><span class="n">null</span> <span class="mi">1</span><span class="n">ul</span> <span class="k">in</span>
  <span class="n">push</span> <span class="o">#</span><span class="nn">Int32</span><span class="p">.</span><span class="n">t</span> <span class="o">#(</span><span class="nn">G</span><span class="p">.</span><span class="n">hide</span> <span class="bp">[]</span><span class="o">)</span> <span class="n">l</span> <span class="mi">1</span><span class="n">l</span><span class="o">;</span>
  <span class="n">push</span> <span class="o">#</span><span class="nn">Int32</span><span class="p">.</span><span class="n">t</span> <span class="o">#(</span><span class="nn">G</span><span class="p">.</span><span class="n">hide</span> <span class="o">[</span><span class="mi">1</span><span class="n">l</span><span class="o">])</span> <span class="n">l</span> <span class="mi">0</span><span class="n">l</span><span class="o">;</span>
  <span class="kd">let</span> <span class="n">r</span> <span class="o">=</span> <span class="n">pop</span> <span class="o">#</span><span class="nn">Int32</span><span class="p">.</span><span class="n">t</span> <span class="o">#(</span><span class="nn">G</span><span class="p">.</span><span class="n">hide</span> <span class="o">[</span><span class="mi">0</span><span class="n">l</span><span class="o">;</span> <span class="mi">1</span><span class="n">l</span><span class="o">])</span> <span class="n">l</span> <span class="k">in</span>
  <span class="nn">TestLib</span><span class="p">.</span><span class="n">checku32</span> <span class="o">(</span><span class="n">length</span> <span class="o">(</span><span class="nn">G</span><span class="p">.</span><span class="n">hide</span> <span class="o">[</span><span class="mi">1</span><span class="n">l</span><span class="o">])</span> <span class="o">!*</span><span class="n">l</span><span class="o">)</span> <span class="mi">1</span><span class="n">ul</span><span class="o">;</span>
  <span class="n">r</span>
</pre></div>
</div>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="TocExamples.html" class="btn btn-neutral float-left" title="Low* examples" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="RingBuffer.html" class="btn btn-neutral float-right" title="Example: RingBuffer" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2018, Jonathan Protzenko.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>